.venv) sysadmin@C2834957912:~/dev/DirectorSync/lp_tenant_importer$ python main.py --tenant core --xlsx samples/core_config.xlsx --format table --no-verify import-enrichment-policies
{"level": "DEBUG", "message": "Parsed arguments: {'tenant': 'core', 'tenants_file': None, 'xlsx': 'samples/core_config.xlsx', 'dry_run': False, 'no_verify': True, 'format': 'table', 'force_create': False, 'command': 'import-enrichment-policies', 'func': <function cmd_import_enrichment_policies at 0x70bb50f968e0>}", "module": "main", "funcName": "main", "lineno": 223, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "opening env file: /home/sysadmin/dev/DirectorSync/lp_tenant_importer/.env", "module": "main", "funcName": "_prepare_context", "lineno": 43, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Loaded API token: ******** (length=564)", "module": "main", "funcName": "_prepare_context", "lineno": 46, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Initialized with base_url=https://10.160.144.185, api_token=**** (raw length=564)", "module": "http", "funcName": "__init__", "lineno": 25, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Headers set: {'User-Agent': 'python-requests/2.32.5', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive', 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7InN1Y2Nlc3MiOjEsIl9rZXkiOiIxMDA1MyIsIl9pZCI6IkRDVXNlcnMvMTAwNTMiLCJ1c2VybmFtZSI6ImFkbWluIiwiZW1haWwiOiJhZG1pbkBsb2dwb2ludC5jb20iLCJyb2xlIjoiYWRtaW4iLCJ1c2VyZ3JvdXBzIjpbXSwiYWN0aXZlIjowLCJpc19uZXciOjEsInBhcmVudF9pZCI6InJvb3QiLCJwYXJlbnRfZGlzcGxheV9uYW1lIjoicm9vdCIsInVwZGF0ZWRfYnkiOiJyb290IiwiYXV0aFR5cGUiOiJkY19hdXRoIn0sInRva2VuVXVpZCI6IjFkZjMyYzc3LTVlZjktNDQxZi04YjJjLWE3ZDgxM2Q0MDJjZSIsInRva2VuVHlwZSI6InVzZXJfZ2VuZXJhdGVkIiwic2NvcGUiOiJhZG1pbiIsImlhdCI6MTc1ODU4NjcyM30.i2H8apMSFYr1oh2Rfk4LYqNU4FN6843QNRSGm-xLeGA', 'Content-Type': 'application/json'}", "module": "http", "funcName": "__init__", "lineno": 31, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "tenant config : {'tenants': {'core': {'pool_uuid': 'a9fa7661c4f84b278b136e94a86b4ea2', 'siems': {'search_heads': [{'id': 'fake-sh-id', 'name': 'fake-search-head'}], 'backends': [{'id': '506caf32de83054497d07c3c632a98cb', 'name': 'lb-backend01'}, {'id': '01925abf82fe0db0a75c190c4316b8a6', 'name': 'lb-backend02'}], 'all_in_one': []}, 'defaults': {'target': {'repos': ['backends', 'all_in_one'], 'routing_policies': ['backends', 'all_in_one'], 'normalization_policies': ['backends', 'all_in_one'], 'processing_policies': ['backends', 'all_in_one'], 'enrichment-policies': ['backends', 'all_in_one'], 'alerts': 'search_heads'}}}}, 'defaults': {'target': {'repos': ['backends', 'all_in_one'], 'routing_policies': ['backends', 'all_in_one'], 'normalization_policies': ['backends', 'all_in_one'], 'processing_policies': ['backends', 'all_in_one'], 'enrichment-policies': ['backends', 'all_in_one'], 'alerts': 'search_heads'}, 'xlsx': {'dir': '~/.local/share/lp_importer/', 'pattern': 'config-{tenant}.xlsx'}}}", "module": "config_loader", "funcName": "load_tenants_file", "lineno": 61, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Tenant core: 2 backends, 1 search_heads, 0 all_in_one", "module": "config_loader", "funcName": "get_tenant", "lineno": 93, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Collected nodes: 2 backends", "module": "nodes", "funcName": "collect_nodes", "lineno": 28, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Collected nodes: 1 search_heads", "module": "nodes", "funcName": "collect_nodes", "lineno": 28, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Collected nodes: 0 all_in_one", "module": "nodes", "funcName": "collect_nodes", "lineno": 28, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "De-duplicated nodes: {'backends': [<core.nodes.Node object at 0x70bb51e9b560>, <core.nodes.Node object at 0x70bb510592e0>], 'search_heads': [<core.nodes.Node object at 0x70bb51b847a0>], 'all_in_one': []}", "module": "main", "funcName": "_prepare_context", "lineno": 69, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Loaded API token: {\"length\":564}", "module": "main", "funcName": "_prepare_context", "lineno": 71, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "tenant config : {'tenants': {'core': {'pool_uuid': 'a9fa7661c4f84b278b136e94a86b4ea2', 'siems': {'search_heads': [{'id': 'fake-sh-id', 'name': 'fake-search-head'}], 'backends': [{'id': '506caf32de83054497d07c3c632a98cb', 'name': 'lb-backend01'}, {'id': '01925abf82fe0db0a75c190c4316b8a6', 'name': 'lb-backend02'}], 'all_in_one': []}, 'defaults': {'target': {'repos': ['backends', 'all_in_one'], 'routing_policies': ['backends', 'all_in_one'], 'normalization_policies': ['backends', 'all_in_one'], 'processing_policies': ['backends', 'all_in_one'], 'enrichment-policies': ['backends', 'all_in_one'], 'alerts': 'search_heads'}}}}, 'defaults': {'target': {'repos': ['backends', 'all_in_one'], 'routing_policies': ['backends', 'all_in_one'], 'normalization_policies': ['backends', 'all_in_one'], 'processing_policies': ['backends', 'all_in_one'], 'enrichment-policies': ['backends', 'all_in_one'], 'alerts': 'search_heads'}, 'xlsx': {'dir': '~/.local/share/lp_importer/', 'pattern': 'config-{tenant}.xlsx'}}}", "module": "config_loader", "funcName": "load_tenants_file", "lineno": 61, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Tenant core: 2 backends, 1 search_heads, 0 all_in_one", "module": "config_loader", "funcName": "get_tenant", "lineno": 93, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Loaded sheets: EnrichmentPolicy (18 rows), Rules (11 rows), Criteria (35 rows)", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 366, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Built payload for policy_id 62dcc0b3350735dbcb6205cd: {'data': {'id': '62dcc0b3350735dbcb6205cd', 'name': 'UEBA_ENRICHMENT_POLICY', 'description': np.float64(nan), 'tags': np.float64(nan), 'active': np.True_, 'specifications': [{'source': 'GeoIp', 'rules': [], 'criteria': [{'type': 'KeyPresentsValueMatches', 'key': 'norm_id', 'value': 'Office365'}, {'type': 'KeyPresentsValueMatches', 'key': 'application', 'value': 'AzureActiveDirectory'}]}, {'source': 'GeoIp_source_address', 'rules': [], 'criteria': [{'type': 'KeyPresentsValueMatches', 'key': 'label', 'value': '.*VPN.*'}, {'type': 'KeyPresents', 'key': 'source_address', 'value': nan}, {'type': 'KeyPresentsValueMatches', 'key': 'sub_category', 'value': '(GlobalProtect|globalprotect)'}, {'type': 'KeyPresents', 'key': 'source_address', 'value': nan}]}, {'source': 'UEBA_ActiveDirectoryUsers', 'rules': [{'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'SI_USER'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'mail', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'sender'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}, {'category': 'simple', 'source_key': 'sAMAccountName', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'user'}], 'criteria': [{'type': 'KeyPresentsValueMatches', 'key': 'norm_id', 'value': 'WinServer.*'}, {'type': 'KeyPresentsValueMatches', 'key': 'event_id', 'value': '(307|462[4|5]|4648|476[8|9]|477[0|1|2|3]|477[6|7]|4656|466[3|4]|5145)'}, {'type': 'KeyPresentsValueMatches', 'key': 'norm_id', 'value': '^(LP4SAP|agileSI)$'}, {'type': 'KeyPresentsValueMatches', 'key': 'SI_EXTR', 'value': 'SI_SAL'}, {'type': 'KeyPresentsValueMatches', 'key': 'SI_SIGID', 'value': '^(AU[1-3|5-6])$'}, {'type': 'KeyPresentsValueMatches', 'key': 'device_category', 'value': 'ProxyServer'}, {'type': 'KeyPresentsValueMatches', 'key': 'device_category', 'value': 'Email.*'}, {'type': 'KeyPresentsValueMatches', 'key': 'label', 'value': '.*VPN.*'}, {'type': 'KeyPresents', 'key': 'source_address', 'value': nan}, {'type': 'KeyPresentsValueMatches', 'key': 'sub_category', 'value': '(GlobalProtect|globalprotect)'}, {'type': 'KeyPresents', 'key': 'source_address', 'value': nan}, {'type': 'KeyPresents', 'key': 'user', 'value': nan}, {'type': 'KeyPresents', 'key': 'object_name', 'value': nan}, {'type': 'KeyPresents', 'key': 'status', 'value': nan}, {'type': 'KeyPresentsValueMatches', 'key': 'label', 'value': '(.*Authentication.*|.*Login.*)'}, {'type': 'KeyPresents', 'key': 'user', 'value': nan}, {'type': 'KeyPresentsValueMatches', 'key': 'norm_id', 'value': 'Office365'}, {'type': 'KeyPresentsValueMatches', 'key': 'application', 'value': 'AzureActiveDirectory'}]}, {'source': 'UEBA_SourceAddrToHostname', 'rules': [], 'criteria': [{'type': 'KeyPresentsValueMatches', 'key': 'norm_id', 'value': 'WinServer.*'}, {'type': 'KeyPresentsValueMatches', 'key': 'event_id', 'value': '(462[4|5]|4648|476[8|9]|477[0|1|2|3]|477[6|7]|4656|466[3|4]|5145)'}, {'type': 'KeyPresentsValueMatches', 'key': 'device_category', 'value': 'ProxyServer'}, {'type': 'KeyPresents', 'key': 'user', 'value': nan}, {'type': 'KeyPresents', 'key': 'object_name', 'value': nan}, {'type': 'KeyPresents', 'key': 'status', 'value': nan}, {'type': 'KeyPresentsValueMatches', 'key': 'label', 'value': '(.*Authentication.*|.*Login.*)'}]}]}}", "module": "enrichment_policies", "funcName": "build_enrichment_payloads", "lineno": 113, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Built payload for policy_id 62dcc0c3f1fa2022ab0872e7: {'data': {'id': '62dcc0c3f1fa2022ab0872e7', 'name': 'Threat_Intelligence', 'description': np.float64(nan), 'tags': np.float64(nan), 'active': np.True_, 'specifications': [{'source': 'threat_intelligence', 'rules': [{'category': 'simple', 'source_key': 'ip_address', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'source_address'}, {'category': 'simple', 'source_key': 'ip_address', 'prefix': False, 'operation': 'Equals', 'type': 'ip', 'event_key': 'destination_address'}], 'criteria': [{'type': 'KeyPresents', 'key': 'source_address', 'value': 'found'}, {'type': 'KeyPresents', 'key': 'destination_address', 'value': 'found'}, {'type': 'KeyPresents', 'key': 'source_address', 'value': 'found'}, {'type': 'KeyPresents', 'key': 'destination_address', 'value': 'found'}]}]}}", "module": "enrichment_policies", "funcName": "build_enrichment_payloads", "lineno": 113, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Processing 3 nodes: {'backends': [<core.nodes.Node object at 0x70bb51e9b560>, <core.nodes.Node object at 0x70bb510592e0>], 'search_heads': [<core.nodes.Node object at 0x70bb51b847a0>], 'all_in_one': []}", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 377, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Starting new HTTPS connection (1): 10.160.144.185:443", "module": "connectionpool", "funcName": "_new_conn", "lineno": 1049, "timestamp": "2025-09-25T13:33:51-0400"}
/home/sysadmin/dev/DirectorSync/lp_tenant_importer/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:1097: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.160.144.185'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
{"level": "DEBUG", "message": "https://10.160.144.185:443 \"GET /configapi/a9fa7661c4f84b278b136e94a86b4ea2/506caf32de83054497d07c3c632a98cb/EnrichmentSource HTTP/1.1\" 200 None", "module": "connectionpool", "funcName": "_make_request", "lineno": 544, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Fetched ES list for node lb-backend01: dict_keys([''])", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 159, "timestamp": "2025-09-25T13:33:51-0400"}
/home/sysadmin/dev/DirectorSync/lp_tenant_importer/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:1097: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.160.144.185'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
{"level": "DEBUG", "message": "https://10.160.144.185:443 \"GET /configapi/a9fa7661c4f84b278b136e94a86b4ea2/506caf32de83054497d07c3c632a98cb/EnrichmentPolicy HTTP/1.1\" 200 None", "module": "connectionpool", "funcName": "_make_request", "lineno": 544, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Fetched EP list for node lb-backend01: dict_keys(['UEBA_ENRICHMENT_POLICY'])", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 174, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "WARNING", "message": "Skipping UEBA_ENRICHMENT_POLICY on lb-backend01 due to missing ES: ['GeoIp', 'UEBA_ActiveDirectoryUsers', 'GeoIp_source_address', 'UEBA_SourceAddrToHostname']", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 190, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "WARNING", "message": "Skipping Threat_Intelligence on lb-backend01 due to missing ES: ['threat_intelligence']", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 190, "timestamp": "2025-09-25T13:33:51-0400"}
/home/sysadmin/dev/DirectorSync/lp_tenant_importer/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:1097: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.160.144.185'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
{"level": "DEBUG", "message": "https://10.160.144.185:443 \"GET /configapi/a9fa7661c4f84b278b136e94a86b4ea2/01925abf82fe0db0a75c190c4316b8a6/EnrichmentSource HTTP/1.1\" 200 None", "module": "connectionpool", "funcName": "_make_request", "lineno": 544, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Fetched ES list for node lb-backend02: dict_keys([''])", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 159, "timestamp": "2025-09-25T13:33:51-0400"}
/home/sysadmin/dev/DirectorSync/lp_tenant_importer/.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:1097: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.160.144.185'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#tls-warnings
  warnings.warn(
{"level": "DEBUG", "message": "https://10.160.144.185:443 \"GET /configapi/a9fa7661c4f84b278b136e94a86b4ea2/01925abf82fe0db0a75c190c4316b8a6/EnrichmentPolicy HTTP/1.1\" 200 None", "module": "connectionpool", "funcName": "_make_request", "lineno": 544, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "DEBUG", "message": "Fetched EP list for node lb-backend02: dict_keys(['UEBA_ENRICHMENT_POLICY'])", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 174, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "WARNING", "message": "Skipping UEBA_ENRICHMENT_POLICY on lb-backend02 due to missing ES: ['GeoIp', 'UEBA_ActiveDirectoryUsers', 'GeoIp_source_address', 'UEBA_SourceAddrToHostname']", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 190, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "WARNING", "message": "Skipping Threat_Intelligence on lb-backend02 due to missing ES: ['threat_intelligence']", "module": "enrichment_policies", "funcName": "check_existing_per_node", "lineno": 190, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "INFO", "message": "SKIP for UEBA_ENRICHMENT_POLICY on lb-backend02", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 407, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "INFO", "message": "SKIP for Threat_Intelligence on lb-backend02", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 407, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "INFO", "message": "SKIP for UEBA_ENRICHMENT_POLICY on lb-backend02", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 407, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "INFO", "message": "SKIP for Threat_Intelligence on lb-backend02", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 407, "timestamp": "2025-09-25T13:33:51-0400"}
{"level": "INFO", "message": "Import summary: {'SKIP': 4}", "module": "enrichment_policies", "funcName": "import_enrichment_policies_for_nodes", "lineno": 442, "timestamp": "2025-09-25T13:33:51-0400"}
| siem         | node         | name                   | result  | action | error                                                                                         |
| ------------ | ------------ | ---------------------- | ------- | ------ | --------------------------------------------------------------------------------------------- |
| lb-backend02 | lb-backend02 | UEBA_ENRICHMENT_POLICY | Skipped | SKIP   | Missing ES: GeoIp, UEBA_ActiveDirectoryUsers, GeoIp_source_address, UEBA_SourceAddrToHostname |
| lb-backend02 | lb-backend02 | Threat_Intelligence    | Skipped | SKIP   | Missing ES: threat_intelligence                                                               |
| lb-backend02 | lb-backend02 | UEBA_ENRICHMENT_POLICY | Skipped | SKIP   | Missing ES: GeoIp, UEBA_ActiveDirectoryUsers, GeoIp_source_address, UEBA_SourceAddrToHostname |
| lb-backend02 | lb-backend02 | Threat_Intelligence    | Skipped | SKIP   | Missing ES: threat_intelligence                                                               |
